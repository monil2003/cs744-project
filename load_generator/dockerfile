
FROM ubuntu:22.04 AS builder
ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y \
    build-essential cmake git curl zip unzip pkg-config && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /build

RUN git clone https://github.com/microsoft/vcpkg.git /opt/vcpkg && \
    /opt/vcpkg/bootstrap-vcpkg.sh

COPY CMakeLists.txt main.cpp ./

RUN /opt/vcpkg/vcpkg install cpp-httplib

RUN rm -rf build && \
    cmake -B build -S . -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_TOOLCHAIN_FILE=/opt/vcpkg/scripts/buildsystems/vcpkg.cmake && \
    cmake --build build --config Release

FROM ubuntu:22.04 AS runtime
RUN apt-get update && apt-get install -y libstdc++6 && rm -rf /var/lib/apt/lists/*
WORKDIR /app
COPY --from=builder /build/build/loader /app/loader
ENTRYPOINT ["./loader"]

