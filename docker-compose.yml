version: "3.8"
services:
  db1:
    image: postgres:16
    container_name: stress_postgres_1
    restart: always
    environment:
      POSTGRES_USER: stressuser
      POSTGRES_PASSWORD: stresspass
      POSTGRES_DB: stressdb
      max_connections: 200 # This parameter is already handled correctly via the command
    ports:
      - "5432:5432" # Changed to 5432 for the first container
    volumes:
      - pgdata1:/var/lib/postgresql/data
    command: postgres -c max_connections=200
    deploy:
      resources:
        limits:
          cpus: '4.0'
    cpuset: "0-2"
  
  db2:
    image: postgres:16
    container_name: stress_postgres_2
    restart: always
    environment:
      POSTGRES_USER: stressuser
      POSTGRES_PASSWORD: stresspass
      POSTGRES_DB: stressdb
      max_connections: 200 # This parameter is already handled correctly via the command
    ports:
      - "5433:5432" # Changed to a different host port (5433) for the second container
    volumes:
      - pgdata2:/var/lib/postgresql/data # Changed to a different volume for the second container
    command: postgres -c max_connections=200
    deploy:
      resources:
        limits:
          cpus: '4.0'
    cpuset: "3-5" # Changed to a different cpuset

  # db3:
  #   image: postgres:16
  #   container_name: stress_postgres_3
  #   restart: always
  #   environment:
  #     POSTGRES_USER: stressuser
  #     POSTGRES_PASSWORD: stresspass
  #     POSTGRES_DB: stressdb
  #     max_connections: 200 # This parameter is already handled correctly via the command
  #   ports:
  #     - "5434:5432" # Changed to a different host port (5433) for the second container
  #   volumes:
  #     - pgdata3:/var/lib/postgresql/data # Changed to a different volume for the second container
  #   command: postgres -c max_connections=200
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '4.0'
  #   cpuset: "4-5" # Changed to a different cpuset

volumes:
  pgdata1:
  pgdata2:
  pgdata3:
